-- Migration: Add applier earnings tracking
-- Date: 2025-12-31

-- Table to track all applier earnings (base pay + bonuses)
CREATE TABLE applier_earnings (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    applier_id uuid NOT NULL REFERENCES appliers(id),
    client_id uuid REFERENCES clients(id),  -- NULL for general base pay
    
    -- Earnings type and amount
    earnings_type text NOT NULL,  -- 'base_pay', 'application_milestone', 'interview_bonus', 'placement_bonus'
    amount numeric(10, 2) NOT NULL,
    
    -- Reference to what triggered this earning
    application_count integer NULL,  -- For application milestones (e.g., 100, 200, 300)
    interview_id uuid REFERENCES interviews(id),  -- For interview bonuses
    
    -- Date tracking
    earned_date date NOT NULL DEFAULT CURRENT_DATE,
    pay_period_start date NULL,  -- For base_pay tracking
    pay_period_end date NULL,    -- For base_pay tracking
    
    -- Payment status
    payment_status text NOT NULL DEFAULT 'pending',  -- 'pending', 'approved', 'paid'
    paid_date date NULL,
    
    -- Metadata
    notes text NULL,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
);

-- Indexes for performance
CREATE INDEX idx_applier_earnings_applier_id ON applier_earnings(applier_id);
CREATE INDEX idx_applier_earnings_client_id ON applier_earnings(client_id);
CREATE INDEX idx_applier_earnings_type ON applier_earnings(earnings_type);
CREATE INDEX idx_applier_earnings_status ON applier_earnings(payment_status);
CREATE INDEX idx_applier_earnings_earned_date ON applier_earnings(earned_date);

-- Comments for clarity
COMMENT ON TABLE applier_earnings IS 'Tracks all applier earnings including base pay and bonuses';
COMMENT ON COLUMN applier_earnings.earnings_type IS 'Types: base_pay, application_milestone, interview_bonus, placement_bonus';
COMMENT ON COLUMN applier_earnings.amount IS 'Dollar amount earned';
COMMENT ON COLUMN applier_earnings.application_count IS 'Milestone number (100, 200, 300) for application bonuses';
COMMENT ON COLUMN applier_earnings.payment_status IS 'Status: pending, approved, paid';

-- Helper view: Total earnings per applier
CREATE VIEW applier_earnings_summary AS
SELECT 
    applier_id,
    SUM(amount) FILTER (WHERE earnings_type = 'base_pay') as total_base_pay,
    SUM(amount) FILTER (WHERE earnings_type = 'application_milestone') as total_application_bonuses,
    SUM(amount) FILTER (WHERE earnings_type = 'interview_bonus') as total_interview_bonuses,
    SUM(amount) FILTER (WHERE earnings_type = 'placement_bonus') as total_placement_bonuses,
    SUM(amount) as total_earnings,
    SUM(amount) FILTER (WHERE payment_status = 'paid') as total_paid,
    SUM(amount) FILTER (WHERE payment_status = 'pending') as total_pending
FROM applier_earnings
GROUP BY applier_id;

-- Helper view: Client costs
CREATE VIEW client_costs_summary AS
SELECT 
    c.id as client_id,
    c.first_name || ' ' || c.last_name as client_name,
    COUNT(DISTINCT a.id) as total_applications,
    COUNT(DISTINCT i.id) as total_interviews,
    SUM(ae.amount) as total_cost,
    SUM(ae.amount) FILTER (WHERE ae.payment_status = 'paid') as paid_amount,
    SUM(ae.amount) FILTER (WHERE ae.payment_status = 'pending') as pending_amount
FROM clients c
LEFT JOIN applications a ON a.client_id = c.id
LEFT JOIN interviews i ON i.client_id = c.id
LEFT JOIN applier_earnings ae ON ae.client_id = c.id
GROUP BY c.id, c.first_name, c.last_name;